from __future__ import division
import numpy as np
from Core.QuadratureRules.FeketePointsTri import *

def hpBasesLagrange(C,xi,eta):
    """ Consructs nodal bases lagrange shape functions with Fekete 
        nodes based on Pascal's triangles

                                1
                        x               y
                    x**2        xy          y**2
                x**3    x**2*y      x*y**2      y**3
            x**4    x**3*y  x**2*y**2   x*y**3      y**4
        x**5    x**4*y  x**3*y**2   x**2*y**3   x*y**4  y**5             

        For instance to consruct quadratic bases functions we have 
        one polynomial of the type:

        N(x,y) = a1+a2*x+a3*y+a4*x**2+a5*x*y+a6*y**2  # 6 coefficients

        where x and y are the parent coordinates (not the physical ones).
        This polynomial is then evaluated at all triangular Fekete points.
        There would be 6 Fekete points for this case:

            [(-1,-1),(1,-1),(-1,1),(0,-1),(-1,0),(0,0)]

        evaluating the polynomial at these 6 points would give us 6 equations
        in terms of coefficients a_i, which results in a Vandermonde matrix.
        Solving the Vandermonde matrix with an rhs which is zero every where 
        apart from one node would give one of the shape functions. Repeating  
        this we will obtain 6 bases functions.

                                (-1,1)
                                    |\
                                    | \
                                    |  \
                                    |   \
                                    |    \
                                    |     \
                            (-1,-1) -------- (1,-1)



        Returns:

            Bases           [np.ndarray of doubles ] bases functions
            gBasesx         [np.ndarray of doubles ] gradient of bases functions wrt x
            gBasesy         [np.ndarray of doubles ] gradient of bases functions wrt y
            ggBasesxx       [np.ndarray of doubles ] hessian of bases functions wrt x and x
            ggBasesxy       [np.ndarray of doubles ] hessian of bases functions wrt x and y
            ggBasesyx       [np.ndarray of doubles ] hessian of bases functions wrt y and x
            ggBasesyy       [np.ndarray of doubles ] hessian of bases functions wrt y and y

        """

    x = xi 
    y = eta

    nsize = int((C+2)*(C+3)/2)
    gBases = np.zeros((nsize,2),dtype=np.float64)
    ggBases = np.zeros((nsize,2,2),dtype=np.float64)


    if C==1:

        Bases = np.array([
             x**2/2. + x*y + x/2. + y**2/2. + y/2.,
                   (x*(x + 1))/2,
                   (y*(y + 1))/2,
                -(x + y)*(x + 1),
                -(x + y)*(y + 1),
                 (x + 1)*(y + 1),
            ])

        gBasesx = np.array([
               x + y + 1/2.,
                   x + 1/2.,
                         0.,
             - 2*x - y - 1.,
                   - y - 1.,
                     y + 1.,
            ])

        gBasesy = np.array([
               x + y + 1/2.,
                          0,
                   y + 1/2.,
                    - x - 1,
             - x - 2.*y - 1,
                      x + 1,
            ])

        ggBasesxx = np.array([ 1., 1, 0, -2, 0, 0])
        ggBasesxy = np.array([ 1., 0, 0, -1, -1, 1])
        ggBasesyx = np.array([ 1., 0, 0, -1, -1, 1])
        ggBasesyy = np.array([ 1., 0, 1, 0, -2, 0])

    elif C==2:

        Bases = np.array([
                                                                                                                                                                                                                                                                          - (5*x**3)/8 - 2*x**2*y - (11*x**2)/8 - 2*x*y**2 - (11*x*y)/4 - (5*x)/8 - (5*y**3)/8 - (11*y**2)/8 - (5*y)/8 - 1/2251799813685248,
                                                                                                                                                                                                                                                                                                                                                       -((x + 1)*(- 5*x**2 + x*y + x + y**2 + y + 1))/8,
                                                                                                                                                                                                                                                            - (4056890586614813*x**3)/40564819207303340847894502572032 - (x**2*y)/8 - x**2/8 - (x*y**2)/8 - (x*y)/4 - x/8 + (5*y**3)/8 + y**2/2 - y/4 - 1/8,
                                                                               (5*5**(1/2)*x**3)/8 + (6831541189506395*x**2*y)/2251799813685248 + (2712083152976557*x**2)/1125899906842624 + (7369110560110821*x*y**2)/4503599627370496 + (2277180396502131*x*y)/562949953421312 + (2277180396502129*x)/2251799813685248 + (7369110560110821*y**2)/4503599627370496 + (2277180396502129*y)/2251799813685248,
                                                        (8601109929670857*x*y**2)/36028797018963968 - (869805512948851*y)/2251799813685248 - (3479222051795405*x*y)/2251799813685248 - (5*5**(1/2)*x**3)/8 - (1739611025897699*x)/4503599627370496 - (1304708269423277*x**2*y)/1125899906842624 - (2008395711199917*x**2)/1125899906842624 + (8601109929670857*y**2)/36028797018963968 - 1/4503599627370496,
 - (5409187448819751*x**3)/10141204801825835211973625643008 + (7369110560110821*x**2*y)/4503599627370496 + (3684555280055409*x**2)/2251799813685248 + (6831541189506395*x*y**2)/2251799813685248 + (2277180396502131*x*y)/562949953421312 + (1138590198251065*x)/1125899906842624 + (5*5**(1/2)*y**3)/8 + (1356041576488279*y**2)/562949953421312 + (142323774781383*y)/140737488355328 - 3/2251799813685248,
                                                                                                                                                                                                                              (7212249931759667*x**3)/20282409603651670423947251286016 - (27*y)/8 - (27*x*y)/4 - (27*x*y**2)/8 - (27*x**2*y)/8 - (27*x**2)/8 - (27*x)/8 - (27*y**2)/8 + 5/2251799813685248,
                                                              - (7212249931759667*x**3)/40564819207303340847894502572032 + (7369110560110815*x**2*y)/4503599627370496 + (7369110560110815*x**2)/4503599627370496 + (2150277482417697*x*y**2)/9007199254740992 + (5*x*y)/2 + (2545965081804343*x)/1125899906842624 + (2150277482417697*y**2)/9007199254740992 + (3889888508315405*y)/4503599627370496 + 5/8,
  (537569370604429*x**2*y)/2251799813685248 - (1739611025897699*y)/4503599627370496 - (3479222051795405*x*y)/2251799813685248 - (5*5**(1/2)*y**3)/8 - (1304708269423277*x*y**2)/1125899906842624 - (217451378237213*x)/562949953421312 + (2150277482417715*x**2)/9007199254740992 + (4056890586614813*x**3)/10141204801825835211973625643008 - (8033582844799669*y**2)/4503599627370496 + 5/9007199254740992,
                                                               - (5409187448819751*x**3)/20282409603651670423947251286016 + (8601109929670797*x**2*y)/36028797018963968 + (2150277482417697*x**2)/9007199254740992 + (7369110560110817*x*y**2)/4503599627370496 + (5*x*y)/2 + (243118031769713*x)/281474976710656 + (3684555280055409*y**2)/2251799813685248 + (5091930163608687*y)/2251799813685248 + 5/8
                                                               ])

        gBasesx = np.array([                                                                                                                                                                            - (11*x)/4 - (11*y)/4 - 4*x*y - (15*x**2)/8 - 2*y**2 - 5/8,
                                                                                                                                                                                      (5*x**2)/8 - y/8 - (x*y)/8 - x/8 - y**2/8 - ((x + 1)*(y - 10*x + 1))/8 - 1/8,
                                                                                                                                                                  - x/4 - y/4 - (x*y)/4 - (12170671759844439*x**2)/40564819207303340847894502572032 - y**2/8 - 1/8,
                                        (15*5**(1/2)*x**2)/8 + (6831541189506395*x*y)/1125899906842624 + (2712083152976557*x)/562949953421312 + (7369110560110821*y**2)/4503599627370496 + (2277180396502131*y)/562949953421312 + 2277180396502129/2251799813685248,
                                       (8601109929670857*y**2)/36028797018963968 - (3479222051795405*y)/2251799813685248 - (1304708269423277*x*y)/562949953421312 - (15*5**(1/2)*x**2)/8 - (2008395711199917*x)/562949953421312 - 1739611025897699/4503599627370496,
 (3684555280055409*x)/1125899906842624 + (2277180396502131*y)/562949953421312 + (7369110560110821*x*y)/2251799813685248 - (16227562346459253*x**2)/10141204801825835211973625643008 + (6831541189506395*y**2)/2251799813685248 + 1138590198251065/1125899906842624,
                                                                                                                                                 (21636749795279001*x**2)/20282409603651670423947251286016 - (27*y)/4 - (27*x*y)/4 - (27*x)/4 - (27*y**2)/8 - 27/8,
                              (7369110560110815*x)/2251799813685248 + (5*y)/2 + (7369110560110815*x*y)/2251799813685248 - (21636749795279001*x**2)/40564819207303340847894502572032 + (2150277482417697*y**2)/9007199254740992 + 2545965081804343/1125899906842624,
   (2150277482417715*x)/4503599627370496 - (3479222051795405*y)/2251799813685248 + (537569370604429*x*y)/1125899906842624 + (12170671759844439*x**2)/10141204801825835211973625643008 - (1304708269423277*y**2)/1125899906842624 - 217451378237213/562949953421312,
                               (2150277482417697*x)/4503599627370496 + (5*y)/2 + (8601109929670797*x*y)/18014398509481984 - (16227562346459253*x**2)/20282409603651670423947251286016 + (7369110560110817*y**2)/4503599627370496 + 243118031769713/281474976710656
 
 

            ])


        gBasesy = np.array([

 
                                                                                                                                                                 - (11*x)/4 - (11*y)/4 - 4*x*y - 2*x**2 - (15*y**2)/8 - 5/8,
                                                                                                                                                                                               -((x + 1)*(x + 2*y + 1))/8,
                                                                                                                                                                           - x**2/8 - (x*y)/4 - x/4 + (15*y**2)/8 + y - 1/4,
                     (2277180396502131*x)/562949953421312 + (7369110560110821*y)/2251799813685248 + (7369110560110821*x*y)/2251799813685248 + (6831541189506395*x**2)/2251799813685248 + 2277180396502129/2251799813685248,
                   (8601109929670857*y)/18014398509481984 - (3479222051795405*x)/2251799813685248 + (8601109929670857*x*y)/18014398509481984 - (1304708269423277*x**2)/1125899906842624 - 869805512948851/2251799813685248,
   (7369110560110821*x**2)/4503599627370496 + (6831541189506395*x*y)/1125899906842624 + (2277180396502131*x)/562949953421312 + (15*5**(1/2)*y**2)/8 + (1356041576488279*y)/281474976710656 + 142323774781383/140737488355328,
                                                                                                                                                                   - (27*x)/4 - (27*y)/4 - (27*x*y)/4 - (27*x**2)/8 - 27/8,
                                                  (5*x)/2 + (2150277482417697*y)/4503599627370496 + (2150277482417697*x*y)/4503599627370496 + (7369110560110815*x**2)/4503599627370496 + 3889888508315405/4503599627370496,
 (537569370604429*x**2)/2251799813685248 - (8033582844799669*y)/2251799813685248 - (1304708269423277*x*y)/562949953421312 - (15*5**(1/2)*y**2)/8 - (3479222051795405*x)/2251799813685248 - 1739611025897699/4503599627370496,
                                                 (5*x)/2 + (3684555280055409*y)/1125899906842624 + (7369110560110817*x*y)/2251799813685248 + (8601109929670797*x**2)/36028797018963968 + 5091930163608687/2251799813685248

            ])

        ggBasesxx = np.array([ - (15*x)/4 - 4*y - 11/4, 
            (15*x)/4 - y/4 + 1, 
            - (12170671759844439*x)/20282409603651670423947251286016 - y/4 - 1/4, 
            (6831541189506395*y)/1125899906842624 + (15*5**(1/2)*x)/4 + 2712083152976557/562949953421312, 
            - (1304708269423277*y)/562949953421312 - (15*5**(1/2)*x)/4 - 2008395711199917/562949953421312, 
            (7369110560110821*y)/2251799813685248 - (16227562346459253*x)/5070602400912917605986812821504 + 3684555280055409/1125899906842624, 
            (21636749795279001*x)/10141204801825835211973625643008 - (27*y)/4 - 27/4, 
            (7369110560110815*y)/2251799813685248 - (21636749795279001*x)/20282409603651670423947251286016 + 7369110560110815/2251799813685248, 
            (12170671759844439*x)/5070602400912917605986812821504 + (537569370604429*y)/1125899906842624 + 2150277482417715/4503599627370496, 
            (8601109929670797*y)/18014398509481984 - (16227562346459253*x)/10141204801825835211973625643008 + 2150277482417697/4503599627370496])

        ggBasesxy = np.array([ - 4*x - 4*y - 11/4, 
            - x/4 - y/4 - 1/4, 
            - x/4 - y/4 - 1/4, 
            (6831541189506395*x)/1125899906842624 + (7369110560110821*y)/2251799813685248 + 2277180396502131/562949953421312, 
            (8601109929670857*y)/18014398509481984 - (1304708269423277*x)/562949953421312 - 3479222051795405/2251799813685248, 
            (7369110560110821*x)/2251799813685248 + (6831541189506395*y)/1125899906842624 + 2277180396502131/562949953421312, 
            - (27*x)/4 - (27*y)/4 - 27/4, 
            (7369110560110815*x)/2251799813685248 + (2150277482417697*y)/4503599627370496 + 5/2, 
            (537569370604429*x)/1125899906842624 - (1304708269423277*y)/562949953421312 - 3479222051795405/2251799813685248, 
            (8601109929670797*x)/18014398509481984 + (7369110560110817*y)/2251799813685248 + 5/2])

        ggBasesyx = np.array([ - 4*x - 4*y - 11/4, 
            - x/4 - y/4 - 1/4, 
            - x/4 - y/4 - 1/4, 
            (6831541189506395*x)/1125899906842624 + (7369110560110821*y)/2251799813685248 + 2277180396502131/562949953421312, 
            (8601109929670857*y)/18014398509481984 - (1304708269423277*x)/562949953421312 - 3479222051795405/2251799813685248, 
            (7369110560110821*x)/2251799813685248 + (6831541189506395*y)/1125899906842624 + 2277180396502131/562949953421312, 
            - (27*x)/4 - (27*y)/4 - 27/4, 
            (7369110560110815*x)/2251799813685248 + (2150277482417697*y)/4503599627370496 + 5/2, 
            (537569370604429*x)/1125899906842624 - (1304708269423277*y)/562949953421312 - 3479222051795405/2251799813685248, 
            (8601109929670797*x)/18014398509481984 + (7369110560110817*y)/2251799813685248 + 5/2])

        ggBasesyy = np.array([ - 4*x - (15*y)/4 - 11/4, 
            - x/4 - 1/4, 
            (15*y)/4 - x/4 + 1, 
            (7369110560110821*x)/2251799813685248 + 7369110560110821/2251799813685248, 
            (8601109929670857*x)/18014398509481984 + 8601109929670857/18014398509481984, 
            (6831541189506395*x)/1125899906842624 + (15*5**(1/2)*y)/4 + 1356041576488279/281474976710656, 
            - (27*x)/4 - 27/4, 
            (2150277482417697*x)/4503599627370496 + 2150277482417697/4503599627370496, 
            - (1304708269423277*x)/562949953421312 - (15*5**(1/2)*y)/4 - 8033582844799669/2251799813685248, 
            (7369110560110817*x)/2251799813685248 + 3684555280055409/1125899906842624])
 
 






    gBases[:,0] = gBasesx
    gBases[:,1] = gBasesy

    ggBases[:,0,0] = ggBasesxx
    ggBases[:,0,1] = ggBasesxy
    ggBases[:,1,0] = ggBasesxy
    ggBases[:,1,1] = ggBasesyy

    return Bases, gBases, ggBases
